; VSS OMNI TELECOM - Asterisk Dialplan Configuration
; Полная конфигурация dialplan для работы со слотами и внешними вызовами

[general]
static=yes
writeprotect=no
clearglobalvars=no
autofallthrough=yes
priorityjumping=no

[globals]
; Глобальные переменные
VSS_DOMAIN=vss.internal
KAMAILIO_HOST=kamailio
KAMAILIO_PORT=5060

; ============================================
; INTERNAL CONTEXT - Внутренние вызовы
; ============================================

[internal]
; Внутренние вызовы к слотам через Kamailio
; AUTO slots: 6xxx (6001-6999)
exten => _6XXX,1,NoOp(=== Call to AUTO slot ${EXTEN} ===)
 same => n,Set(SLOT_ID=${EXTEN:1})
 same => n,Set(SLOT_USERNAME=slot_${SLOT_ID}@${VSS_DOMAIN})
 same => n,Set(CDR(userfield)=AUTO_SLOT_${SLOT_ID})
 same => n,Set(CDR(accountcode)=AUTO)
 same => n,NoOp(Dialing to ${SLOT_USERNAME})
 same => n,Dial(PJSIP/${SLOT_USERNAME}@kamailio,30,Tt)
 same => n,Hangup()

; MF slots: 7xxx (7001-7999)
exten => _7XXX,1,NoOp(=== Call to MF slot ${EXTEN} ===)
 same => n,Set(SLOT_ID=${EXTEN:1})
 same => n,Set(SLOT_USERNAME=slot_${SLOT_ID}@${VSS_DOMAIN})
 same => n,Set(CDR(userfield)=MF_SLOT_${SLOT_ID})
 same => n,Set(CDR(accountcode)=MF)
 same => n,NoOp(Dialing to ${SLOT_USERNAME})
 same => n,Dial(PJSIP/${SLOT_USERNAME}@kamailio,30,Tt)
 same => n,Hangup()

; LS slots: 8xxx (8001-8999)
exten => _8XXX,1,NoOp(=== Call to LS slot ${EXTEN} ===)
 same => n,Set(SLOT_ID=${EXTEN:1})
 same => n,Set(SLOT_USERNAME=slot_${SLOT_ID}@${VSS_DOMAIN})
 same => n,Set(CDR(userfield)=LS_SLOT_${SLOT_ID})
 same => n,Set(CDR(accountcode)=LS)
 same => n,NoOp(Dialing to ${SLOT_USERNAME})
 same => n,Dial(PJSIP/${SLOT_USERNAME}@kamailio,30,Tt)
 same => n,Hangup()

; Services: 9xxx (9001-9999)
exten => _9XXX,1,NoOp(=== Call to service ${EXTEN} ===)
 same => n,Goto(services,${EXTEN},1)

; Fallback для неизвестных номеров
exten => _X.,1,NoOp(Unknown internal number: ${EXTEN})
 same => n,Playback(invalid)
 same => n,Hangup()

; ============================================
; SERVICES CONTEXT - Сервисные номера
; ============================================

[services]
; IVR Welcome
exten => 9001,1,Answer()
 same => n,Set(TIMEOUT(digit)=5)
 same => n,Set(TIMEOUT(response)=10)
 same => n,Playback(vm-goodbye)
 same => n,Hangup()

; Echo Test
exten => 9002,1,Answer()
 same => n,Echo()
 same => n,Hangup()

; Beep Test
exten => 9003,1,Answer()
 same => n,Playback(beep)
 same => n,Wait(1)
 same => n,Hangup()

; Time Announcement
exten => 9004,1,Answer()
 same => n,SayUnixTime()
 same => n,Hangup()

; ============================================
; OUTBOUND CONTEXTS - Исходящие вызовы
; ============================================

[outbound-auto]
; Исходящие вызовы от AUTO слотов
exten => _X.,1,NoOp(=== Outbound call to ${EXTEN} from AUTO slot ===)
 same => n,Set(CDR(accountcode)=AUTO_OUTBOUND)
 same => n,Set(CDR(userfield)=OUTBOUND_AUTO)
 same => n,NoOp(Dialing external number: ${EXTEN})
 same => n,Dial(PJSIP/provider/${EXTEN},45,Tt)
 same => n,Hangup()

[outbound-mf]
; Исходящие вызовы от MF слотов
exten => _X.,1,NoOp(=== Outbound call to ${EXTEN} from MF slot ===)
 same => n,Set(CDR(accountcode)=MF_OUTBOUND)
 same => n,Set(CDR(userfield)=OUTBOUND_MF)
 same => n,NoOp(Dialing external number: ${EXTEN})
 same => n,Dial(PJSIP/provider/${EXTEN},45,Tt)
 same => n,Hangup()

[outbound-ls]
; Исходящие вызовы от LS слотов
exten => _X.,1,NoOp(=== Outbound call to ${EXTEN} from LS slot ===)
 same => n,Set(CDR(accountcode)=LS_OUTBOUND)
 same => n,Set(CDR(userfield)=OUTBOUND_LS)
 same => n,NoOp(Dialing external number: ${EXTEN})
 same => n,Dial(PJSIP/provider/${EXTEN},45,Tt)
 same => n,Hangup()

; ============================================
; INBOUND CONTEXT - Входящие вызовы
; ============================================

[inbound]
; Входящие вызовы от внешних провайдеров
exten => _X.,1,NoOp(=== Inbound call to ${EXTEN} ===)
 same => n,Set(CDR(accountcode)=INBOUND)
 same => n,Set(CDR(userfield)=INBOUND_CALL)
 same => n,Answer()
 same => n,Set(TIMEOUT(digit)=10)
 same => n,Set(TIMEOUT(response)=15)
 same => n,Playback(hello-world)
 same => n,Read(DEST,beep,4)
 same => n,GotoIf($["${DEST}" = ""]?hangup)
 same => n,Goto(internal,${DEST},1)
 same => n(hangup),Hangup()

; ============================================
; DEFAULT CONTEXT - Обработка по умолчанию
; ============================================

[default]
exten => _X.,1,NoOp(=== Default handler for ${EXTEN} ===)
 same => n,Answer()
 same => n,Playback(invalid)
 same => n,Hangup()


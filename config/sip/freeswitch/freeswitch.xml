<?xml version="1.0"?>
<document type="freeswitch/xml">
  <!--
    FreeSWITCH Configuration для VSS OMNI TELECOM
    Базовая конфигурация для начала работы
  -->
  
  <section name="configuration" description="FreeSWITCH Core Configuration">
    
    <!-- Основные настройки -->
    <configuration name="switch.conf" description="Core Configuration">
      <settings>
        <param name="colorize-console" value="true"/>
        <param name="loglevel" value="info"/>
      </settings>
    </configuration>
    
    <!-- Модули для загрузки -->
    <configuration name="modules.conf" description="Modules">
      <modules>
        <!-- Loggers -->
        <load module="mod_console"/>
        <load module="mod_logfile"/>
        
        <!-- Applications -->
        <load module="mod_commands"/>
        <load module="mod_dptools"/>
        <load module="mod_db"/>
        <load module="mod_hash"/>
        <load module="mod_conference"/>
        <load module="mod_fifo"/>
        <load module="mod_voicemail"/>
        
        <!-- Dialplan Interfaces -->
        <load module="mod_dialplan_xml"/>
        
        <!-- Endpoints -->
        <load module="mod_sofia"/>
        <load module="mod_loopback"/>
        
        <!-- Applications -->
        <load module="mod_event_socket"/>
        
        <!-- Codecs -->
        <load module="mod_spandsp"/>
        <load module="mod_opus"/>
        <load module="mod_g729"/>
        
        <!-- File Format Interfaces -->
        <load module="mod_sndfile"/>
        <load module="mod_native_file"/>
        <load module="mod_local_stream"/>
        <load module="mod_tone_stream"/>
        
        <!-- Say -->
        <load module="mod_say_en"/>
        <load module="mod_say_ru"/>
        
        <!-- Databases -->
        <load module="mod_pgsql"/>
      </modules>
    </configuration>
    
    <!-- Event Socket для управления через API -->
    <configuration name="event_socket.conf" description="Event Socket Interface">
      <settings>
        <param name="nat-map" value="false"/>
        <param name="listen-ip" value="0.0.0.0"/>
        <param name="listen-port" value="8021"/>
        <param name="password" value="ClueCon"/>
      </settings>
    </configuration>
    
    <!-- Консоль -->
    <configuration name="console.conf" description="Console Logger">
      <settings>
        <param name="colorize" value="true"/>
        <param name="loglevel" value="info"/>
      </settings>
      <mappings>
        <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
      </mappings>
    </configuration>
    
    <!-- Logfile -->
    <configuration name="logfile.conf" description="File Logging">
      <settings>
        <param name="rotate-on-hup" value="true"/>
      </settings>
      <profiles>
        <profile name="default">
          <settings>
            <param name="logfile" value="/var/log/freeswitch/freeswitch.log"/>
            <param name="rollover" value="10485760"/>
          </settings>
          <mappings>
            <map name="all" value="console,debug,info,notice,warning,err,crit,alert"/>
          </mappings>
        </profile>
      </profiles>
    </configuration>
    
    <!-- PostgreSQL Configuration -->
    <configuration name="pgsql.conf" description="PostgreSQL Configuration">
      <settings>
        <param name="connection" value="core"/>
      </settings>
      <connections>
        <connection name="core">
          <param name="hostname" value="${POSTGRES_HOST}"/>
          <param name="hostport" value="${POSTGRES_PORT}"/>
          <param name="database" value="${POSTGRES_DB}"/>
          <param name="username" value="${POSTGRES_USER}"/>
          <param name="password" value="${POSTGRES_PASSWORD}"/>
        </connection>
      </connections>
    </configuration>
    
  </section>
  
  <!-- SIP Profiles -->
  <section name="configuration" description="Sofia SIP Configuration">
    <configuration name="sofia.conf" description="Sofia SIP Stack">
      
      <global_settings>
        <param name="log-level" value="0"/>
        <param name="debug-presence" value="0"/>
      </global_settings>
      
      <profiles>
        <!-- Internal SIP Profile -->
        <profile name="internal">
          <settings>
            <param name="sip-ip" value="$${local_ip_v4}"/>
            <param name="sip-port" value="5080"/>
            <param name="rtp-ip" value="$${local_ip_v4}"/>
            <param name="dialplan" value="XML"/>
            <param name="context" value="public"/>
            <param name="dtmf-duration" value="2000"/>
            <param name="inbound-codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="outbound-codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="rtp-timer-name" value="soft"/>
            <param name="hold-music" value="$${hold_music}"/>
            <param name="manage-presence" value="true"/>
            <param name="inbound-codec-negotiation" value="generous"/>
            <param name="auth-calls" value="true"/>
            <param name="nonce-ttl" value="60"/>
            <param name="rtp-timeout-sec" value="300"/>
            <param name="rtp-hold-timeout-sec" value="1800"/>
            <param name="debug" value="0"/>
            <param name="sip-trace" value="no"/>
          </settings>
        </profile>
        
        <!-- External SIP Profile -->
        <profile name="external">
          <settings>
            <param name="sip-ip" value="$${local_ip_v4}"/>
            <param name="ext-sip-ip" value="$${external_ip_v4}"/>
            <param name="sip-port" value="5080"/>
            <param name="ext-rtp-ip" value="$${external_ip_v4}"/>
            <param name="rtp-ip" value="$${local_ip_v4}"/>
            <param name="dialplan" value="XML"/>
            <param name="context" value="public"/>
            <param name="dtmf-duration" value="2000"/>
            <param name="inbound-codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="outbound-codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="codec-prefs" value="OPUS,G722,PCMU,PCMA,G729"/>
            <param name="rtp-timer-name" value="soft"/>
            <param name="hold-music" value="$${hold_music}"/>
            <param name="inbound-codec-negotiation" value="generous"/>
            <param name="rtp-timeout-sec" value="300"/>
            <param name="rtp-hold-timeout-sec" value="1800"/>
            <param name="debug" value="0"/>
            <param name="sip-trace" value="no"/>
            <param name="auth-calls" value="false"/>
          </settings>
        </profile>
      </profiles>
      
    </configuration>
  </section>
  
  <!-- Dialplan Configuration -->
  <section name="dialplan" description="Dialplan">
    <context name="public">
      
      <!-- Echo Test -->
      <extension name="echo">
        <condition field="destination_number" expression="^9196$">
          <action application="answer"/>
          <action application="echo"/>
        </condition>
      </extension>
      
      <!-- Hold Music Test -->
      <extension name="hold_music">
        <condition field="destination_number" expression="^9195$">
          <action application="answer"/>
          <action application="playback" data="$${hold_music}"/>
        </condition>
      </extension>
      
      <!-- Default route -->
      <extension name="default">
        <condition field="destination_number" expression="^(.*)$">
          <action application="log" data="INFO Incoming call to ${destination_number}"/>
          <action application="answer"/>
          <action application="playback" data="ivr/ivr-welcome.wav"/>
          <action application="hangup"/>
        </condition>
      </extension>
      
    </context>
  </section>
  
  <!-- Directory (Users) -->
  <section name="directory" description="User Directory">
    <domain name="$${domain}">
      <params>
        <param name="dial-string" value="{presence_id=${dialed_user}@${dialed_domain}}${sofia_contact(${dialed_user}@${dialed_domain})}"/>
      </params>
      
      <variables>
        <variable name="record_stereo" value="true"/>
        <variable name="transfer_fallback_extension" value="operator"/>
        <variable name="toll_allow" value="domestic,international,local"/>
        <variable name="accountcode" value="1000"/>
        <variable name="user_context" value="default"/>
        <variable name="effective_caller_id_name" value="Extension 1000"/>
        <variable name="effective_caller_id_number" value="1000"/>
        <variable name="outbound_caller_id_name" value="$${outbound_caller_name}"/>
        <variable name="outbound_caller_id_number" value="$${outbound_caller_id}"/>
        <variable name="callgroup" value="techsupport"/>
      </variables>
      
      <groups>
        <group name="default">
          <users>
            <!-- Пример пользователя -->
            <user id="1000">
              <params>
                <param name="password" value="1234"/>
                <param name="vm-password" value="1000"/>
              </params>
              <variables>
                <variable name="toll_allow" value="domestic,international,local"/>
                <variable name="accountcode" value="1000"/>
                <variable name="user_context" value="default"/>
                <variable name="effective_caller_id_name" value="Extension 1000"/>
                <variable name="effective_caller_id_number" value="1000"/>
                <variable name="outbound_caller_id_name" value="FreeSWITCH"/>
                <variable name="outbound_caller_id_number" value="0000000000"/>
                <variable name="callgroup" value="techsupport"/>
              </variables>
            </user>
          </users>
        </group>
      </groups>
    </domain>
  </section>
  
</document>


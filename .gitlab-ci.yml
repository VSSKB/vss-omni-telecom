variables:
  DOCKER_REGISTRY: registry.vss.io
  APP_NAME: vss-core
  K8S_NAMESPACE: vss-production
  
stages:
  - validate
  - test
  - security
  - build
  - deploy-staging
  - integration-test
  - deploy-production
  - post-deploy

default:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - apk add --no-cache curl jq git
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Validation stage
validate-code:
  stage: validate
  image: node:20-alpine
  before_script:
    - apk add --no-cache curl jq git
    # Docker login для доступа к приватному registry (если требуется)
    - |
      if command -v docker >/dev/null 2>&1; then
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || true
      fi
  script:
    - npm ci
    - npm run lint || true
    - npm run type-check || true
  artifacts:
    when: always
    paths:
      - node_modules/
    expire_in: 1 hour
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  only:
    - merge_requests
    - main
    - develop

# Testing stage
unit-tests:
  stage: test
  image: node:20-alpine
  services:
    - postgres:14-alpine
    - redis:7-alpine
  before_script:
    - apk add --no-cache curl jq git
    # Docker login для доступа к приватному registry (если требуется)
    - |
      if command -v docker >/dev/null 2>&1; then
        docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY || true
      fi
  variables:
    POSTGRES_DB: vss_test
    POSTGRES_USER: postgres
    # Используем переменную окружения GitLab CI для пароля тестовой БД
    POSTGRES_PASSWORD: $TEST_DB_PASSWORD
    REDIS_URL: redis://redis:6379
  script:
    - npm ci
    - npm run test:unit || true
    - npm run test:integration || true
  artifacts:
    when: always
    paths:
      - coverage/
    expire_in: 1 week
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  parallel: 2

# Security scanning
security-scan:
  stage: security
  image: alpine:3.18
  script:
    - apk add --no-cache curl
    - echo "Security scan placeholder"
  allow_failure: false

dependency-scan:
  stage: security
  image: node:20-alpine
  script:
    - npm ci
    - npm audit --audit-level moderate || true
  artifacts:
    when: always
    paths:
      - npm-audit-report.json
    expire_in: 3d

# Build stage
build-container:
  stage: build
  before_script:
    - apk add --no-cache curl jq git
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA -f services/workspace/Dockerfile .
    - docker push $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA
    - docker tag $DOCKER_REGISTRY/$APP_NAME:$CI_COMMIT_SHA $DOCKER_REGISTRY/$APP_NAME:latest
    - docker push $DOCKER_REGISTRY/$APP_NAME:latest
  artifacts:
    paths:
      - docker-images.txt
    expire_in: 1 week

# Staging deployment
deploy-staging:
  stage: deploy-staging
  image: alpine:3.18
  environment:
    name: staging
    url: https://staging.vss.example.com
  before_script:
    - apk add --no-cache curl docker-compose
  script:
    - cd $CI_PROJECT_DIR
    - docker-compose -f docker-compose.production.yml pull
    - docker-compose -f docker-compose.production.yml up -d
    - sleep 30
    - curl -f http://localhost/health || exit 1
  only:
    - develop

# Integration tests
integration-tests:
  stage: integration-test
  image: curlimages/curl:8.2.1
  environment:
    name: staging
    url: https://staging.vss.example.com
  script:
    - |
      echo "Running integration tests..."
      curl -f http://localhost/health || exit 1
  dependencies:
    - deploy-staging
  only:
    - develop

# Production deployment
deploy-production:
  stage: deploy-production
  image: alpine:3.18
  environment:
    name: production
    url: https://vss.example.com
  before_script:
    - apk add --no-cache curl docker-compose
  script:
    - cd $CI_PROJECT_DIR
    - docker-compose -f docker-compose.production.yml pull
    - docker-compose -f docker-compose.production.yml up -d
    - sleep 30
    - curl -f http://localhost/health || exit 1
  when: manual
  only:
    - main

# Post-deployment tasks
post-deploy:
  stage: post-deploy
  image: alpine:3.18
  environment:
    name: production
    url: https://vss.example.com
  script:
    - apk add --no-cache curl
    - |
      echo "Running post-deployment checks..."
      curl -f http://localhost/health || exit 1
  dependencies:
    - deploy-production
  when: on_success
  only:
    - main

# Pipeline configuration
workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_TAG


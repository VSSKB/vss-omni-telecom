# Автоматический поиск свободных портов

## Описание

Система автоматически проверяет доступность портов при создании проектов и находит свободные порты, если указанные порты заняты.

## Как это работает

### 1. Проверка доступности портов

При создании проекта система проверяет каждый порт тремя способами:

1. **Проверка системной доступности порта** - пытается открыть сокет на порту
2. **Проверка использования в Docker контейнерах** - проверяет, не используется ли порт в запущенных контейнерах
3. **Проверка использования в других проектах** - проверяет, не назначен ли порт другим проектам

### 2. Автоматический поиск свободного порта

Если запрошенный порт занят, система:
- Логирует предупреждение о занятости порта
- Автоматически ищет свободный порт, начиная со случайной точки в диапазоне 10000-60000
- Назначает найденный свободный порт
- Логирует информацию об изменении порта

### 3. API для генерации портов

**GET `/api/generate-ports`**

Генерирует набор свободных портов для нового проекта:
- `nginx` - начиная с 8080
- `backend` - случайный свободный порт
- `frontend` - случайный свободный порт
- `mikopbx` - случайный свободный порт
- `db` - случайный свободный порт
- `rabbitmq` - случайный свободный порт
- `rabbitmqMgmt` - случайный свободный порт

**Пример ответа:**
```json
{
  "nginx": 8080,
  "backend": 12345,
  "frontend": 12346,
  "mikopbx": 12347,
  "db": 12348,
  "rabbitmq": 12349,
  "rabbitmqMgmt": 12350
}
```

### 4. Валидация при создании проекта

**POST `/api/generate-project`**

При создании проекта система автоматически:
1. Проверяет все переданные порты
2. Если порт занят - находит свободный
3. Обновляет docker-compose.yml с валидированными портами
4. Сохраняет валидированные порты в метаданных проекта

**Пример лога:**
```
[PROJECT] Порт 8080 для nginx занят, ищем свободный...
[PROJECT] Найден свободный порт 8081 для nginx
[PROJECT] Некоторые порты были изменены из-за занятости:
  nginx: 8080 -> 8081
```

## Функции

### `isPortAvailable(port)`
Проверяет, доступен ли порт на системном уровне.

### `isPortUsedByDocker(port)`
Проверяет, используется ли порт в Docker контейнерах.

### `isPortUsedByProjects(port, excludeProjectId)`
Проверяет, используется ли порт в других проектах (исключая указанный проект).

### `findAvailablePort(startPort, maxAttempts, excludeProjectId)`
Находит свободный порт, начиная с `startPort`, проверяя до `maxAttempts` портов.

## Примеры использования

### Создание проекта с автоматическим поиском портов

```javascript
// 1. Генерируем порты
const portsResponse = await fetch('/api/generate-ports');
const ports = await portsResponse.json();

// 2. Создаем проект (порты будут автоматически проверены и исправлены)
const projectResponse = await fetch('/api/generate-project', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    projectName: 'My Project',
    ports: ports,
    includeMikopbx: true,
    includePostgres: true,
    db: {
      dbName: 'mydb',
      dbUser: 'user',
      dbPassword: 'pass'
    }
  })
});
```

### Ручная проверка порта

```javascript
// Проверка доступности порта через API
const checkPort = async (port) => {
  // Системная проверка
  const server = net.createServer();
  server.listen(port, () => {
    console.log(`Порт ${port} свободен`);
    server.close();
  });
  server.on('error', () => {
    console.log(`Порт ${port} занят`);
  });
};
```

## Ограничения

- Максимальное количество попыток поиска порта: 1000
- Диапазон портов: 10000-65535 (для случайных портов)
- Nginx порт проверяется начиная с 8080
- Система не проверяет порты ниже 10000 (кроме nginx)

## Логирование

Все изменения портов логируются в консоль:
- `[PROJECT] Порт X для Y занят, ищем свободный...`
- `[PROJECT] Найден свободный порт Z для Y`
- `[PROJECT] Некоторые порты были изменены из-за занятости:`

## Обработка ошибок

Если не удается найти свободный порт:
- Возвращается ошибка 500
- Сообщение об ошибке включает детали проблемы
- Проект не создается

---

**Версия:** 1.0  
**Дата:** 2025-01-XX

